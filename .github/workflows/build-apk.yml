name: Build Android APK

on:
    push:
        branches: [ main ]
    pull_request:
        branches: [ main ]
    workflow_dispatch:

jobs:
    build:
        runs-on: ubuntu-latest
        
        steps:
        - name: Checkout code
          uses: actions/checkout@v4
          
        - name: Setup Node.js
          uses: actions/setup-node@v4
          with:
              node-version: '18'
              
        - name: Install Cordova CLI
          run: npm install -g cordova
          
        - name: Setup Java
          uses: actions/setup-java@v4
          with:
              distribution: 'temurin'
              java-version: '17'
              
        - name: Setup Android environment
          run: |
              echo "ANDROID_HOME=$ANDROID_HOME"
              echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT"
              echo "JAVA_HOME=$JAVA_HOME"
              
        - name: Initialize Cordova project
          run: |
              cordova create temp-project com.thecodexwalker.game "The Codex Walker"
              cp -r temp-project/* .
              cp -r temp-project/.* . 2>/dev/null || true
              rm -rf temp-project
              
        - name: Add Android platform
          run: cordova platform add android@12.0.0
          
        - name: Install dependencies
          run: npm install
          
        - name: Add Cordova plugins
          run: |
              cordova plugin add cordova-plugin-whitelist
              cordova plugin add cordova-plugin-file
              cordova plugin add cordova-plugin-media
              cordova plugin add cordova-plugin-splashscreen
              cordova plugin add cordova-plugin-statusbar
              cordova plugin add cordova-plugin-inappbrowser
              
        - name: Build Android APK
          run: cordova build android --verbose
          
        - name: Upload APK artifact
          uses: actions/upload-artifact@v4
          with:
              name: thecodexwalker-apk
              path: platforms/android/app/build/outputs/apk/debug/app-debug.apk
              
        - name: Build Release APK
          run: |
              cordova build android --release --verbose
              keytool -genkey -v -keystore my-release-key.keystore -alias alias_name -keyalg RSA -keysize 2048 -validity 10000 -storepass android -keypass android -dname "CN=Android Debug,O=Android,C=US"
              jarsigner -verbose -sigalg SHA1withRSA -digestalg SHA1 -keystore my-release-key.keystore -storepass android -keypass android app-release-unsigned.apk alias_name
              zipalign -v 4 app-release-unsigned.apk thecodexwalker-release.apk
              
        - name: Upload Release APK
          uses: actions/upload-artifact@v4
          with:
              name: thecodexwalker-release-apk
              path: thecodexwalker-release.apk
