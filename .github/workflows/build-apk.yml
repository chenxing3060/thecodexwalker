name: Build Android APK

on:
    push:
        branches: [ main ]
    pull_request:
        branches: [ main ]
    workflow_dispatch:

jobs:
    build:
        runs-on: ubuntu-latest
        
        steps:
        - name: Checkout code
          uses: actions/checkout@v4
          
        - name: Setup Node.js
          uses: actions/setup-node@v4
          with:
              node-version: '18'
              
        - name: Install Cordova CLI
          run: npm install -g cordova@11.0.0
          
        - name: Setup Java
          uses: actions/setup-java@v4
          with:
              distribution: 'temurin'
              java-version: '17'
              
        - name: Setup Android SDK manually
          run: |
              # æ‰‹åŠ¨è®¾ç½®Android SDKç¯å¢ƒå˜é‡
              export ANDROID_HOME="$HOME/android-sdk"
              export ANDROID_SDK_ROOT="$HOME/android-sdk"
              
              # åˆ›å»ºAndroid SDKç›®å½•
              mkdir -p $ANDROID_HOME
              
              # ä¸‹è½½Android SDKå‘½ä»¤è¡Œå·¥å…·
              wget https://dl.google.com/android/repository/commandlinetools-linux-8512546_latest.zip
              unzip -q commandlinetools-linux-8512546_latest.zip
              
              # åˆ›å»ºæ­£ç¡®çš„ç›®å½•ç»“æ„
              mkdir -p $ANDROID_HOME/cmdline-tools
              mv cmdline-tools $ANDROID_HOME/cmdline-tools/latest
              
              # è®¾ç½®ç¯å¢ƒå˜é‡
              echo "ANDROID_HOME=$ANDROID_HOME" >> $GITHUB_ENV
              echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
              echo "$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$ANDROID_HOME/build-tools/32.0.0" >> $GITHUB_PATH
              
        - name: Install Android SDK components
          run: |
              export ANDROID_HOME="$HOME/android-sdk"
              export PATH="$PATH:$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$ANDROID_HOME/build-tools/32.0.0"
              
              # æ£€æŸ¥sdkmanageræ˜¯å¦å­˜åœ¨
              ls -la $ANDROID_HOME/cmdline-tools/latest/bin/
              
              # æ¥å—è®¸å¯è¯
              yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses
              
              # å®‰è£…å¿…è¦çš„SDKç»„ä»¶
              $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "platforms;android-32" "build-tools;32.0.0" "platform-tools"
              
        - name: Setup Android environment
          run: |
              echo "ANDROID_HOME=$ANDROID_HOME"
              echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT"
              echo "JAVA_HOME=$JAVA_HOME"
              echo "PATH includes Android tools:"
              echo $PATH | tr ':' '\n' | grep android
              
        - name: Force Gradle version
          run: |
              # å¼ºåˆ¶ä¸‹è½½å¹¶ä½¿ç”¨Gradle 7.6.1
              wget https://services.gradle.org/distributions/gradle-7.6.1-bin.zip
              unzip -q gradle-7.6.1-bin.zip
              export PATH="$PWD/gradle-7.6.1/bin:$PATH"
              echo "GRADLE_HOME=$PWD/gradle-7.6.1" >> $GITHUB_ENV
              echo "$PWD/gradle-7.6.1/bin" >> $GITHUB_PATH
              gradle --version
              
        - name: Initialize Cordova project
          run: |
              cordova create temp-project com.thecodexwalker.game "The Codex Walker"
              cp -r temp-project/* .
              cp -r temp-project/.* . 2>/dev/null || true
              rm -rf temp-project
              
              # åˆ›å»ºwwwç›®å½•ç»“æ„
              mkdir -p www
              
              # å¤åˆ¶æ¸¸æˆæ–‡ä»¶åˆ°wwwç›®å½•
              echo "Copying game files to www directory..."
              cp -r *.html www/ 2>/dev/null || true
              cp -r css/ www/ 2>/dev/null || true
              cp -r js/ www/ 2>/dev/null || true
              cp -r data/ www/ 2>/dev/null || true
              cp -r game/ www/ 2>/dev/null || true
              cp -r style.css www/ 2>/dev/null || true
              
              # æ˜¾ç¤ºwwwç›®å½•å†…å®¹
              echo "www directory contents:"
              ls -la www/
              echo "www/css contents:"
              ls -la www/css/ 2>/dev/null || echo "No css directory"
              echo "www/js contents:"
              ls -la www/js/ 2>/dev/null || echo "No js directory"
              echo "www/data contents:"
              ls -la www/data/ 2>/dev/null || echo "No data directory"
              echo "www/game contents:"
              ls -la www/game/ 2>/dev/null || echo "No game directory"
              
        - name: Generate APK Icons
          run: |
              echo "ğŸ¨ å¼€å§‹ç”ŸæˆAndroid APKå›¾æ ‡..."
              
              # æ£€æŸ¥åŸå›¾æ˜¯å¦å­˜åœ¨
              if [ ! -f "jimeng-2025-08-20-2954-å®‰å“æ¸¸æˆlogoï¼Œç§‘æŠ€ä¸å¥‡å¹»å…ƒç´ ï¼Œæ–‡å­—_ä¸‡ç‰©è¡Œè€…__å‰¯æœ¬.png" ]; then
                  echo "âŒ åŸå›¾æ–‡ä»¶ä¸å­˜åœ¨ï¼"
                  exit 1
              fi
              
              # åˆ›å»ºå›¾æ ‡ç›®å½•
              mkdir -p res/icon/android
              mkdir -p res/screen/android
              
              # å®‰è£…ImageMagick
              echo "ğŸ“¦ å®‰è£…ImageMagick..."
              sudo apt-get update
              sudo apt-get install -y imagemagick
              
              # ç”Ÿæˆå„ç§å°ºå¯¸çš„å›¾æ ‡
              echo "ğŸ”„ ç”Ÿæˆå›¾æ ‡æ–‡ä»¶..."
              
              # å›¾æ ‡å°ºå¯¸åˆ—è¡¨
              declare -a icon_sizes=("36" "48" "72" "96" "144" "192")
              declare -a density_names=("ldpi" "mdpi" "hdpi" "xhdpi" "xxhdpi" "xxxhdpi")
              
              for i in "${!icon_sizes[@]}"; do
                  size="${icon_sizes[$i]}"
                  density="${density_names[$i]}"
                  
                  echo "ç”Ÿæˆ ${density} å›¾æ ‡ (${size}x${size})..."
                  convert "jimeng-2025-08-20-2954-å®‰å“æ¸¸æˆlogoï¼Œç§‘æŠ€ä¸å¥‡å¹»å…ƒç´ ï¼Œæ–‡å­—_ä¸‡ç‰©è¡Œè€…__å‰¯æœ¬.png" \
                      -resize "${size}x${size}" \
                      -background transparent \
                      -gravity center \
                      -extent "${size}x${size}" \
                      "res/icon/android/drawable-${density}-icon.png"
              done
              
              # ç”Ÿæˆå¯åŠ¨ç”»é¢
              echo "ğŸ”„ ç”Ÿæˆå¯åŠ¨ç”»é¢..."
              
              # å¯åŠ¨ç”»é¢å°ºå¯¸åˆ—è¡¨
              declare -a screen_sizes=("320x426" "320x470" "480x640" "480x800" "720x960" "720x1280")
              declare -a screen_densities=("port-ldpi" "port-mdpi" "port-hdpi" "port-xhdpi" "port-xxhdpi" "port-xxxhdpi")
              
              for i in "${!screen_sizes[@]}"; do
                  size="${screen_sizes[$i]}"
                  density="${screen_densities[$i]}"
                  
                  echo "ç”Ÿæˆ ${density} å¯åŠ¨ç”»é¢ (${size})..."
                  convert "jimeng-2025-08-20-2954-å®‰å“æ¸¸æˆlogoï¼Œç§‘æŠ€ä¸å¥‡å¹»å…ƒç´ ï¼Œæ–‡å­—_ä¸‡ç‰©è¡Œè€…__å‰¯æœ¬.png" \
                      -resize "${size}" \
                      -background "linear-gradient(135deg, #667eea 0%, #764ba2 100%)" \
                      -gravity center \
                      -extent "${size}" \
                      "res/screen/android/screen-${density}.png"
              done
              
              echo "âœ… å›¾æ ‡ç”Ÿæˆå®Œæˆï¼"
              echo "ğŸ“ å›¾æ ‡æ–‡ä»¶ä½ç½®: res/icon/android/"
              echo "ğŸ“ å¯åŠ¨ç”»é¢ä½ç½®: res/screen/android/"
              echo "ğŸ“ ç”Ÿæˆçš„æ–‡ä»¶:"
              ls -la res/icon/android/
              ls -la res/screen/android/
              
        - name: Add Android platform
          run: |
              if [ -d "platforms/android" ]; then
                  echo "ç§»é™¤ç°æœ‰çš„Androidå¹³å°..."
                  cordova platform remove android
              fi
              
              echo "æ·»åŠ Androidå¹³å°..."
              cordova platform add android@11.0.0
              
              echo "Androidå¹³å°æ·»åŠ å®Œæˆï¼"
              ls -la platforms/
              
        - name: Configure Cordova Icons
          run: |
              echo "ğŸ”§ é…ç½®Cordovaå›¾æ ‡..."
              
              # ç­‰å¾…Androidå¹³å°å®Œå…¨åˆå§‹åŒ–
              sleep 5
              
              # æ£€æŸ¥ç›®å½•ç»“æ„
              echo "æ£€æŸ¥ç›®å½•ç»“æ„..."
              ls -la platforms/android/app/src/main/res/ 2>/dev/null || echo "Android resç›®å½•ä¸å­˜åœ¨"
              
              # å¤åˆ¶å›¾æ ‡åˆ°Cordovaé¡¹ç›®
              if [ -d "res/icon/android" ] && [ -d "platforms/android/app/src/main/res" ]; then
                  echo "å¤åˆ¶å›¾æ ‡æ–‡ä»¶..."
                  
                  # åˆ›å»ºæ­£ç¡®çš„ç›®å½•ç»“æ„
                  mkdir -p platforms/android/app/src/main/res/drawable-ldpi
                  mkdir -p platforms/android/app/src/main/res/drawable-mdpi
                  mkdir -p platforms/android/app/src/main/res/drawable-hdpi
                  mkdir -p platforms/android/app/src/main/res/drawable-xhdpi
                  mkdir -p platforms/android/app/src/main/res/drawable-xxhdpi
                  mkdir -p platforms/android/app/src/main/res/drawable-xxxhdpi
                  
                  # å¤åˆ¶å›¾æ ‡åˆ°å¯¹åº”ç›®å½•
                  cp res/icon/android/drawable-ldpi-icon.png platforms/android/app/src/main/res/drawable-ldpi/icon.png
                  cp res/icon/android/drawable-mdpi-icon.png platforms/android/app/src/main/res/drawable-mdpi/icon.png
                  cp res/icon/android/drawable-hdpi-icon.png platforms/android/app/src/main/res/drawable-hdpi/icon.png
                  cp res/icon/android/drawable-xhdpi-icon.png platforms/android/app/src/main/res/drawable-xhdpi/icon.png
                  cp res/icon/android/drawable-xxhdpi-icon.png platforms/android/app/src/main/res/drawable-xxhdpi/icon.png
                  cp res/icon/android/drawable-xxxhdpi-icon.png platforms/android/app/src/main/res/drawable-xxxhdpi/icon.png
                  
                  echo "å›¾æ ‡å¤åˆ¶å®Œæˆï¼"
                  ls -la platforms/android/app/src/main/res/drawable-*/
                  
                  # éªŒè¯å›¾æ ‡æ–‡ä»¶
                  echo "éªŒè¯å›¾æ ‡æ–‡ä»¶..."
                  find platforms/android/app/src/main/res/drawable-* -name "icon.png" -exec ls -la {} \;
                  
                  # æ£€æŸ¥config.xmlä¸­çš„å›¾æ ‡é…ç½®
                  echo "æ£€æŸ¥config.xmlå›¾æ ‡é…ç½®..."
                  if [ -f "config.xml" ]; then
                      echo "config.xmlå†…å®¹:"
                      cat config.xml
                  fi
                  
                  # å¼ºåˆ¶æ›´æ–°å›¾æ ‡é…ç½®
                  echo "å¼ºåˆ¶æ›´æ–°å›¾æ ‡é…ç½®..."
                  sed -i 's/<icon src="res\/icon\/android\/drawable-ldpi-icon.png" density="ldpi" \/>/<icon src="res\/icon\/android\/drawable-ldpi-icon.png" density="ldpi" \/>/g' config.xml
                  sed -i 's/<icon src="res\/icon\/android\/drawable-mdpi-icon.png" density="mdpi" \/>/<icon src="res\/icon\/android\/drawable-mdpi-icon.png" density="mdpi" \/>/g' config.xml
                  sed -i 's/<icon src="res\/icon\/android\/drawable-hdpi-icon.png" density="hdpi" \/>/<icon src="res\/icon\/android\/drawable-hdpi-icon.png" density="hdpi" \/>/g' config.xml
                  sed -i 's/<icon src="res\/icon\/android\/drawable-xhdpi-icon.png" density="xhdpi" \/>/<icon src="res\/icon\/android\/drawable-xhdpi-icon.png" density="xhdpi" \/>/g' config.xml
                  sed -i 's/<icon src="res\/icon\/android\/drawable-xxhdpi-icon.png" density="xxhdpi" \/>/<icon src="res\/icon\/android\/drawable-xxhdpi-icon.png" density="xxhdpi" \/>/g' config.xml
                  sed -i 's/<icon src="res\/icon\/android\/drawable-xxxhdpi-icon.png" density="xxxhdpi" \/>/<icon src="res\/icon\/android\/drawable-xxxhdpi-icon.png" density="xxxhdpi" \/>/g' config.xml
                  
                  echo "å›¾æ ‡é…ç½®æ›´æ–°å®Œæˆï¼"
                  
                  # ç¡®ä¿å›¾æ ‡åœ¨AndroidManifest.xmlä¸­è¢«æ­£ç¡®å¼•ç”¨
                  echo "æ£€æŸ¥AndroidManifest.xml..."
                  if [ -f "platforms/android/app/src/main/AndroidManifest.xml" ]; then
                      echo "AndroidManifest.xmlå†…å®¹:"
                      cat platforms/android/app/src/main/AndroidManifest.xml
                      
                      # ç¡®ä¿å›¾æ ‡å¼•ç”¨æ­£ç¡®
                      echo "æ›´æ–°AndroidManifest.xmlä¸­çš„å›¾æ ‡å¼•ç”¨..."
                      sed -i 's/android:icon="@drawable\/icon"/android:icon="@drawable\/icon"/g' platforms/android/app/src/main/AndroidManifest.xml
                      sed -i 's/android:roundIcon="@drawable\/icon"/android:roundIcon="@drawable\/icon"/g' platforms/android/app/src/main/AndroidManifest.xml
                      
                      echo "AndroidManifest.xmlæ›´æ–°å®Œæˆï¼"
                  fi
                  
              else
                  echo "âŒ å›¾æ ‡ç›®å½•æˆ–Androidå¹³å°ç›®å½•ä¸å­˜åœ¨ï¼"
                  echo "res/icon/android å­˜åœ¨: $([ -d "res/icon/android" ] && echo "æ˜¯" || echo "å¦")"
                  echo "platforms/android/app/src/main/res å­˜åœ¨: $([ -d "platforms/android/app/src/main/res" ] && echo "æ˜¯" || echo "å¦")"
              fi
              
        - name: Configure Gradle compatibility
          run: |
              # åˆ›å»ºgradle.propertiesæ–‡ä»¶ï¼ˆç§»é™¤å·²å¼ƒç”¨çš„é€‰é¡¹ï¼‰
              cat > platforms/android/gradle.properties << EOF
              org.gradle.jvmargs=-Xmx2048m -Dfile.encoding=UTF-8
              android.useAndroidX=true
              android.enableJetifier=true
              android.enableR8.fullMode=false
              android.enableR8=true
              org.gradle.parallel=true
              org.gradle.caching=true
              org.gradle.configureondemand=true
              EOF
              
              # åˆ›å»ºgradle-wrapper.propertiesæ–‡ä»¶
              mkdir -p platforms/android/gradle/wrapper
              cat > platforms/android/gradle/wrapper/gradle-wrapper.properties << EOF
              distributionBase=GRADLE_USER_HOME
              distributionPath=wrapper/dists
              distributionUrl=https\://services.gradle.org/distributions/gradle-7.6.1-bin.zip
              zipStoreBase=GRADLE_USER_HOME
              zipStorePath=wrapper/dists
              EOF
              
              # åˆ›å»ºbuild.gradleæ–‡ä»¶è¦†ç›–
              cat > platforms/android/build.gradle << EOF
              buildscript {
                  repositories {
                      google()
                      mavenCentral()
                  }
                  dependencies {
                      classpath 'com.android.tools.build:gradle:7.4.2'
                  }
              }
              
              allprojects {
                  repositories {
                      google()
                      mavenCentral()
                  }
              }
              EOF
              
              # å¼ºåˆ¶ä½¿ç”¨æˆ‘ä»¬çš„Gradleç‰ˆæœ¬
              echo '#!/bin/bash' > platforms/android/gradlew
              echo 'export GRADLE_HOME="$GITHUB_WORKSPACE/gradle-7.6.1"' >> platforms/android/gradlew
              echo 'export PATH="$GITHUB_WORKSPACE/gradle-7.6.1/bin:$PATH"' >> platforms/android/gradlew
              echo 'exec "$GITHUB_WORKSPACE/gradle-7.6.1/bin/gradle" "$@"' >> platforms/android/gradlew
              chmod +x platforms/android/gradlew
              
        - name: Install dependencies
          run: npm install
          
        - name: Add Cordova plugins
          run: |
              # ç§»é™¤ä¸å…¼å®¹çš„whitelistæ’ä»¶ï¼Œä½¿ç”¨æ›´ç°ä»£çš„æ’ä»¶
              cordova plugin add cordova-plugin-file@6.0.2
              cordova plugin add cordova-plugin-media@5.0.1
              cordova plugin add cordova-plugin-splashscreen@6.0.0
              cordova plugin add cordova-plugin-statusbar@3.0.0
              cordova plugin add cordova-plugin-inappbrowser@5.0.0
              
        - name: Build Android APK
          run: |
              export GRADLE_HOME="$GITHUB_WORKSPACE/gradle-7.6.1"
              export PATH="$GITHUB_WORKSPACE/gradle-7.6.1/bin:$PATH"
              cordova build android --verbose
              
        - name: Upload APK artifact
          uses: actions/upload-artifact@v4
          with:
              name: thecodexwalker-apk
              path: platforms/android/app/build/outputs/apk/debug/app-debug.apk
              
        - name: Build Release APK
          run: |
              echo "ğŸ”¨ æ„å»ºRelease APK..."
              
              # ç¡®ä¿æ¸¸æˆæ–‡ä»¶åœ¨wwwç›®å½•ä¸­
              echo "æ£€æŸ¥wwwç›®å½•å†…å®¹..."
              ls -la www/
              echo "wwwç›®å½•å¤§å°: $(du -sh www/)"
              
              # æ¸…ç†ä¹‹å‰çš„æ„å»º
              echo "æ¸…ç†ä¹‹å‰çš„æ„å»º..."
              rm -rf platforms/android/app/build/
              
              # ä½¿ç”¨Cordovaæ„å»ºï¼Œè¿™æ˜¯æœ€å¯é çš„æ–¹æ³•
              echo "ä½¿ç”¨Cordovaæ„å»ºRelease APK..."
              cordova build android --release --verbose
              
              # æ£€æŸ¥æ„å»ºç»“æœ
              echo "æ£€æŸ¥æ„å»ºç»“æœ..."
              ls -la platforms/android/app/build/outputs/
              
              # æŸ¥æ‰¾ç”Ÿæˆçš„APKæ–‡ä»¶
              if [ -f "platforms/android/app/build/outputs/apk/release/app-release-unsigned.apk" ]; then
                  echo "âœ… Release APKæ„å»ºæˆåŠŸï¼"
                  ls -la platforms/android/app/build/outputs/apk/release/
                  echo "Release APKå¤§å°: $(du -h platforms/android/app/build/outputs/apk/release/app-release-unsigned.apk)"
                  
                  # éªŒè¯APKæ–‡ä»¶å®Œæ•´æ€§
                  echo "éªŒè¯APKæ–‡ä»¶å®Œæ•´æ€§..."
                  file platforms/android/app/build/outputs/apk/release/app-release-unsigned.apk
                  
                  # æ£€æŸ¥ZIPç»“æ„
                  echo "æ£€æŸ¥ZIPç»“æ„..."
                  unzip -t platforms/android/app/build/outputs/apk/release/app-release-unsigned.apk
                  
                  # æ£€æŸ¥APKå†…å®¹
                  echo "æ£€æŸ¥APKå†…å®¹..."
                  unzip -l platforms/android/app/build/outputs/apk/release/app-release-unsigned.apk | head -20
                  
                  # å°†APKå¤åˆ¶åˆ°é¡¹ç›®æ ¹ç›®å½•
                  cp platforms/android/app/build/outputs/apk/release/app-release-unsigned.apk app-release-unsigned.apk
                  echo "APKå·²å¤åˆ¶åˆ°é¡¹ç›®æ ¹ç›®å½•"
                  ls -la app-release-unsigned.apk
                  
                  # éªŒè¯å¤åˆ¶çš„æ–‡ä»¶
                  echo "éªŒè¯å¤åˆ¶çš„APKæ–‡ä»¶..."
                  file app-release-unsigned.apk
                  unzip -t app-release-unsigned.apk
                  
              elif [ -f "platforms/android/app/build/outputs/bundle/release/app-release.aab" ]; then
                  echo "âœ… AABæ–‡ä»¶æ„å»ºæˆåŠŸï¼Œè½¬æ¢ä¸ºAPK..."
                  ls -la platforms/android/app/build/outputs/bundle/release/
                  
                  # ä¸‹è½½bundletool
                  wget https://github.com/google/bundletool/releases/download/1.17.2/bundletool-all-1.17.2.jar
                  
                  # ç”Ÿæˆé€šç”¨APKï¼ˆä¸æ˜¯APKSï¼‰
                  echo "ç”Ÿæˆé€šç”¨APK..."
                  java -jar bundletool-all-1.17.2.jar build-apks --bundle=platforms/android/app/build/outputs/bundle/release/app-release.aab --output=app-release.apks --mode=universal
                  
                  # é‡å‘½åä¸ºAPK
                  mv app-release.apks app-release.apk
                  echo "AABè½¬æ¢ä¸ºAPKå®Œæˆ"
                  ls -la app-release.apk
                  
                  # éªŒè¯è½¬æ¢åçš„APK
                  echo "éªŒè¯è½¬æ¢åçš„APK..."
                  file app-release.apk
                  unzip -t app-release.apk
                  
              else
                  echo "âŒ æ„å»ºå¤±è´¥ï¼Œå°è¯•Debugç‰ˆæœ¬..."
                  cordova build android --debug --verbose
                  
                  if [ -f "platforms/android/app/build/outputs/apk/debug/app-debug.apk" ]; then
                      echo "âœ… Debug APKæ„å»ºæˆåŠŸï¼"
                      ls -la platforms/android/app/build/outputs/apk/debug/
                      echo "Debug APKå¤§å°: $(du -h platforms/android/app/build/outputs/apk/debug/app-debug.apk)"
                      
                      # éªŒè¯Debug APK
                      echo "éªŒè¯Debug APK..."
                      file platforms/android/app/build/outputs/apk/debug/app-debug.apk
                      unzip -t platforms/android/app/build/outputs/apk/debug/app-debug.apk
                      
                      # æ£€æŸ¥Debug APKæ˜¯å¦åŒ…å«è‡ªå®šä¹‰å›¾æ ‡
                      echo "æ£€æŸ¥Debug APKä¸­çš„å›¾æ ‡..."
                      unzip -l platforms/android/app/build/outputs/apk/debug/app-debug.apk | grep -i "icon\|drawable" || echo "æœªæ‰¾åˆ°å›¾æ ‡ç›¸å…³æ–‡ä»¶"
                      
                      # å¤åˆ¶Debug APK
                      cp platforms/android/app/build/outputs/apk/debug/app-debug.apk app-debug.apk
                      echo "Debug APKå·²å¤åˆ¶åˆ°é¡¹ç›®æ ¹ç›®å½•"
                      
                      # éªŒè¯å¤åˆ¶çš„Debug APK
                      echo "éªŒè¯å¤åˆ¶çš„Debug APK..."
                      file app-debug.apk
                      unzip -t app-debug.apk
                  else
                      echo "âŒ æ‰€æœ‰æ„å»ºéƒ½å¤±è´¥äº†ï¼"
                      exit 1
                  fi
              fi
              
              # ç­¾åAPKæ–‡ä»¶
              if [ -f "app-release-unsigned.apk" ]; then
                  echo "ğŸ” ç­¾åRelease APK..."
                  
                  # ç”Ÿæˆæ›´å®‰å…¨çš„ç­¾åå¯†é’¥
                  echo "ç”Ÿæˆç­¾åå¯†é’¥..."
                  keytool -genkey -v -keystore my-release-key.keystore -alias alias_name -keyalg RSA -keysize 2048 -validity 10000 -storepass android -keypass android -dname "CN=Android Debug,O=Android,C=US" -keyalg RSA -sigalg SHA256withRSA
                  
                  # éªŒè¯å¯†é’¥åº“
                  echo "éªŒè¯å¯†é’¥åº“..."
                  keytool -list -keystore my-release-key.keystore -storepass android
                  
                  # ç­¾åAPK
                  echo "å¼€å§‹ç­¾åAPK..."
                  jarsigner -verbose -sigalg SHA256withRSA -digestalg SHA256 -keystore my-release-key.keystore -storepass android -keypass android app-release-unsigned.apk alias_name
                  
                  # éªŒè¯ç­¾å
                  echo "éªŒè¯APKç­¾å..."
                  jarsigner -verify -verbose -certs app-release-unsigned.apk
                  
                  # ä½¿ç”¨zipalignä¼˜åŒ–
                  echo "ä¼˜åŒ–APKæ–‡ä»¶..."
                  $ANDROID_HOME/build-tools/32.0.0/zipalign -v 4 app-release-unsigned.apk thecodexwalker-release.apk
                  
                  echo "âœ… ç­¾åå®Œæˆ: thecodexwalker-release.apk"
                  ls -la thecodexwalker-release.apk
                  echo "APKå¤§å°: $(du -h thecodexwalker-release.apk)"
                  
                  # æœ€ç»ˆéªŒè¯
                  echo "æœ€ç»ˆéªŒè¯APK..."
                  file thecodexwalker-release.apk
                  unzip -t thecodexwalker-release.apk
                  
                  # æ£€æŸ¥APKå†…å®¹
                  echo "æ£€æŸ¥æœ€ç»ˆAPKå†…å®¹..."
                  unzip -l thecodexwalker-release.apk | head -20
                  
              elif [ -f "app-release.apk" ]; then
                  echo "ğŸ” ç­¾åè½¬æ¢åçš„APK..."
                  
                  # ç”Ÿæˆç­¾åå¯†é’¥
                  keytool -genkey -v -keystore my-release-key.keystore -alias alias_name -keyalg RSA -keysize 2048 -validity 10000 -storepass android -keypass android -dname "CN=Android Debug,O=Android,C=US"
                  
                  # ç­¾åAPK
                  jarsigner -verbose -sigalg SHA256withRSA -digestalg SHA256 -keystore my-release-key.keystore -storepass android -keypass android app-release.apk alias_name
                  
                  # éªŒè¯ç­¾å
                  jarsigner -verify -verbose -certs app-release.apk
                  
                  # é‡å‘½å
                  mv app-release.apk thecodexwalker-release.apk
                  echo "âœ… ç­¾åå®Œæˆ: thecodexwalker-release.apk"
                  
                  # éªŒè¯æœ€ç»ˆAPK
                  echo "éªŒè¯æœ€ç»ˆAPK..."
                  file thecodexwalker-release.apk
                  unzip -t thecodexwalker-release.apk
                  
              elif [ -f "app-debug.apk" ]; then
                  echo "ğŸ” ç­¾åDebug APK..."
                  
                  # ç”Ÿæˆç­¾åå¯†é’¥
                  keytool -genkey -v -keystore my-release-key.keystore -alias alias_name -keyalg RSA -keysize 2048 -validity 10000 -storepass android -keypass android -dname "CN=Android Debug,O=Android,C=US"
                  
                  # ç­¾åDebug APK
                  jarsigner -verbose -sigalg SHA256withRSA -digestalg SHA256 -keystore my-release-key.keystore -storepass android -keypass android app-debug.apk alias_name
                  
                  # éªŒè¯ç­¾å
                  jarsigner -verify -verbose -certs app-debug.apk
                  
                  # é‡å‘½å
                  mv app-debug.apk thecodexwalker-debug.apk
                  echo "âœ… Debug APKç­¾åå®Œæˆ: thecodexwalker-debug.apk"
                  
                  # éªŒè¯æœ€ç»ˆAPK
                  echo "éªŒè¯æœ€ç»ˆAPK..."
                  file thecodexwalker-debug.apk
                  unzip -t thecodexwalker-debug.apk
                  
              else
                  echo "âŒ æ²¡æœ‰æ‰¾åˆ°å¯ç­¾åçš„APKæ–‡ä»¶"
                  echo "å½“å‰ç›®å½•æ–‡ä»¶åˆ—è¡¨:"
                  ls -la
                  exit 1
              fi
              
              # æœ€ç»ˆæ£€æŸ¥
              echo "ğŸ¯ æœ€ç»ˆæ£€æŸ¥..."
              if [ -f "thecodexwalker-release.apk" ]; then
                  echo "âœ… Release APKç”ŸæˆæˆåŠŸï¼"
                  echo "æ–‡ä»¶: thecodexwalker-release.apk"
                  echo "å¤§å°: $(du -h thecodexwalker-release.apk)"
                  echo "ç±»å‹: $(file thecodexwalker-release.apk)"
                  
                  # æœ€ç»ˆZIPç»“æ„éªŒè¯
                  echo "æœ€ç»ˆZIPç»“æ„éªŒè¯..."
                  unzip -t thecodexwalker-release.apk
                  
              elif [ -f "thecodexwalker-debug.apk" ]; then
                  echo "âœ… Debug APKç”ŸæˆæˆåŠŸï¼"
                  echo "æ–‡ä»¶: thecodexwalker-debug.apk"
                  echo "å¤§å°: $(du -h thecodexwalker-debug.apk)"
                  echo "ç±»å‹: $(file thecodexwalker-debug.apk)"
                  
                  # æœ€ç»ˆZIPç»“æ„éªŒè¯
                  echo "æœ€ç»ˆZIPç»“æ„éªŒè¯..."
                  unzip -t thecodexwalker-debug.apk
                  
              else
                  echo "âŒ æ²¡æœ‰ç”Ÿæˆæœ‰æ•ˆçš„APKæ–‡ä»¶"
                  exit 1
              fi
              
        - name: Upload Release APK
          uses: actions/upload-artifact@v4
          with:
              name: thecodexwalker-release-apk
              path: thecodexwalker-release.apk
